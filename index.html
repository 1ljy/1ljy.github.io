<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>致我最爱的你 | 三周年快乐</title>
    
    <!-- 预加载关键资源 -->
    <link rel="preload" href="style.css" as="style">
    <link rel="preload" href="./fonts/DancingScript-Bold.woff2" as="font" type="font/woff2" crossorigin>
    
    <!-- 内联关键CSS -->
    <style>
        /* 首屏渲染必须的CSS */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #121212; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loading-spinner { width: 50px; height: 50px; border: 3px solid #333; border-top-color: #e91e63; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: #fff; margin-top: 20px; font-size: 1.2em; }
        .main-container { display: none; }
    </style>
    
    <!-- 异步加载非关键CSS -->
    <link rel="stylesheet" href="style.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="style.css"></noscript>
    
    <!-- 预加载字体 -->
    <style>
        @font-face {
            font-family: 'Dancing Script';
            font-style: normal;
            font-weight: 700;
            src: url('./fonts/DancingScript-Bold.woff2') format('woff2');
            font-display: swap;
        }
    </style>
</head>
<body>

    <!-- 全屏加载遮罩 -->
    <div id="loading-mask">
        <div class="loading-spinner"></div>
        <p class="loading-text">正在准备浪漫...</p>
    </div>

    <!-- 主容器 -->
    <div class="main-container">
        <!-- 1. 动态星空背景 -->
        <div id="particles-js"></div>

        <!-- 2. 背景音乐 -->
        <audio id="bgMusic" loop>
            <source src="music/xiaoxingyun.mp3" type="audio/mpeg">
        </audio>

        <!-- 3. 导航栏 (移动端友好) -->
        <header class="mobile-header">
            <nav class="mobile-nav">
                <div class="nav-item active" data-view="timeline">我们的故事</div>
                <div class="nav-item" data-view="letter">一封情书</div>
                <div class="nav-item" data-view="future">未来约定</div>
                <div class="nav-item" data-view="game">默契大考验</div>
                <div class="nav-item" data-view="constellation">星空下的誓言</div>
            </nav>
        </header>

        <main class="mobile-main">
            <!-- 视图1: 时间轴 -->
            <section id="timeline-view" class="view active">
                <div class="hero-text">
                    <h1>From 2022.03.27 to Forever</h1>
                    <p>已陪伴 <span class="days-counter"></span> 个日夜</p>
                </div>
                <div class="timeline-scroll">
                    <div class="timeline-item">
                        <div class="timeline-date">2021.08.08</div>
                        <div class="timeline-content">
                            <h3>初识 · 一切开始的地方</h3>
                            <div class="photo-grid">
                                <img src="images/photo1.webp" alt="第一次见面" loading="lazy">
                            </div>
                            <p>世界很大，幸好遇见...</p>
                        </div>
                    </div>
                    <!-- 其他时间轴项目... -->
                </div>
            </section>

            <!-- 视图2: 情书 -->
            <section id="letter-view" class="view">
                <div class="letter-container">
                    <div id="unlockForm">
                        <h2>这封信，只属于你</h2>
                        <input type="date" id="birthdayInput" placeholder="输入你的生日">
                        <button id="unlockBtn">解锁 ❤️</button>
                    </div>
                    <div id="letterContent" class="letter-content">
                        <!-- 情书内容将由JS动态填充 -->
                    </div>
                </div>
            </section>

            <!-- 视图3: 未来约定 -->
            <section id="future-view" class="view">
                <div class="future-list">
                    <!-- ... -->
                </div>
            </section>

            <!-- 视图4: 默契大考验 -->
            <section id="game-view" class="view">
                <!-- ... -->
            </section>

            <!-- 视图5: 星空下的誓言 -->
            <section id="constellation-view" class="view">
                <div class="constellation-container">
                    <h1>星空下的誓言</h1>
                    <div id="star-grid" class="star-grid">
                        <!-- 九宫格将由JS动态生成 -->
                    </div>
                    <div class="game-controls">
                        <button id="startGameBtn">开始绘制</button>
                        <button id="checkAnswerBtn" style="display: none;">提交答案</button>
                    </div>
                    <div id="gameHint">点击“开始”，点亮属于我们的第一颗星</div>
                </div>
            </section>
        </main>
    </div>

    <!-- 全屏照片查看器 -->
    <div id="photoViewer" class="photo-viewer">
        <div class="viewer-content">
            <img id="viewerImg" src="" alt="">
            <span class="close-viewer">&times;</span>
        </div>
    </div>

    <!-- 异步加载JS -->
    <script>
        // 核心逻辑
        (function() {
            // 音乐自动播放策略
            const bgMusic = document.getElementById('bgMusic');
            const loadingMask = document.getElementById('loading-mask');
            const loadingText = document.getElementById('loading-text');
            const mainContainer = document.querySelector('.main-container');
            
            function init() {
                loadingText.textContent = "正在准备浪漫...";
                // 尝试播放音乐
                const playPromise = bgMusic.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        // 播放成功，隐藏加载界面
                        loadingMask.style.opacity = '0';
                        setTimeout(() => {
                            loadingMask.style.display = 'none';
                            mainContainer.style.display = 'block';
                            initApp();
                        }, 500);
                    }).catch(error => {
                        // 播放失败，显示手动播放按钮
                        loadingText.innerHTML = "音乐播放失败<br><button id='manualPlayBtn'>点击播放音乐</button>";
                        document.getElementById('manualPlayBtn').addEventListener('click', () => {
                            bgMusic.play().then(initApp);
                        });
                    });
                }
            }

            // 初始化应用
            function initApp() {
                // 加载并初始化所有功能
                loadScript('js/particles.min.js', () => {
                    particlesJS('particles-js', {/* ... */});
                });
                // 其他初始化...
            }

            // 按需加载JS的辅助函数
            function loadScript(src, callback) {
                const s = document.createElement('script');
                s.src = src;
                s.async = true;
                s.onload = callback;
                document.head.appendChild(s);
            }

            // 开始整个流程
            init();
        })();
    </script>
</body>
</html>
